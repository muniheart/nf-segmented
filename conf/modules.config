env.APPTAINER_MESSAGELEVEL=5
env.SINGULARITY_MESSAGELEVEL=5

process {
    withName: SQUASH_WORK {
        publishDir = [
            [
                path: { "${params.outdir}/${task.process.tokenize(':')[-1].toLowerCase()}" },
                pattern: '*.sqfs',
                mode: 'symlink',
                overwrite: true,
            ]
        ]
    }

    withName: NFCORE_DEMO {
        containerOptions = {
            [
                container_opts,
                "--env NXF_CACHE_DIR=/nextflow",
                "-B ${cache_dir}:/nextflow",
            ].join(' ')
        }
    }
    withName: MERGE_IMAGES {
        container "https://depot.galaxyproject.org/singularity/nextflow%3A25.04.6--h2a3209d_0"

        bind_mounts = \
            [
                params.bind_mounts,
            ].findAll().join(",")

        opts = [
            bind_mounts     ? "-B $bind_mounts" : "",
            image_mounts    ? "-B $image_mounts" : "",
        ].findAll().join(' ')

        containerOptions = { opts }

        publishDir = [
            [
                path: { "${params.outdir}/${task.process.tokenize(':')[-1].toLowerCase()}" },
                pattern: '*.sqfs',
                mode: 'symlink',
                overwrite: true,
            ]
        ]
    }
}
